name: Auto sync brotli upstream

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-brotli:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone google/brotli
        run: |
          rm -rf ./brotli
          git clone --depth=1 https://github.com/google/brotli.git ./brotli

      - name: Detect if brotli HEAD is tagged
        id: brotli_tag
        run: |
          cd ./brotli
          git fetch --tags
          tags=$(git tag --points-at HEAD)
          if [ -n "$tags" ]; then
            tag=$(echo "$tags" | head -n 1)
            echo "Brotli HEAD has tag: $tag"
            echo "has_tag=true" >> $GITHUB_ENV
            echo "latest_tag=$tag" >> $GITHUB_ENV
          else
            echo "Brotli HEAD has no tag."
            echo "has_tag=false" >> $GITHUB_ENV
          fi

      - name: Run update script in brotli
        run: |
          chmod +x ./tool/update.sh
          ./tool/update.sh

      - name: Run go tests
        run: |
          set -e
          go test ./...

      - name: Commit and push if there are changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --cached --quiet; then
            commit_msg="Auto update from google/brotli"
            if [ "$has_tag" = "true" ]; then
              commit_msg="$commit_msg tag $latest_tag"
            fi
            git commit -m "$commit_msg"
            git push
          else
            echo "No changes to commit."
            exit 0
          fi

      - name: Create matching tag in this repo
        if: env.has_tag == 'true' && success() && github.ref == 'refs/heads/main'
        run: |
          git tag "$latest_tag"
          git push origin "$latest_tag"
