name: Auto sync brotli upstream

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-brotli:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone google/brotli
        run: |
          rm -rf ./brotli
          git clone --depth=1 https://github.com/google/brotli.git ./brotli

      - name: Extract version info and commit date
        id: version
        run: |
          cd ./brotli

          major=$(grep '#define[[:space:]]\+BROTLI_VERSION_MAJOR' c/common/version.h | awk '{print $3}')
          minor=$(grep '#define[[:space:]]\+BROTLI_VERSION_MINOR' c/common/version.h | awk '{print $3}')
          patch=$(grep '#define[[:space:]]\+BROTLI_VERSION_PATCH' c/common/version.h | awk '{print $3}')

          commit_date=$(git log -1 --format=%cd --date=format:%Y%m%d)

          tag_name="v${major}.${minor}.${patch}-${commit_date}"

          echo "Detected version: $tag_name"
          echo "tag_name=$tag_name" >> $GITHUB_ENV

      - name: Run update script in brotli
        run: |
          chmod +x ./tool/update.sh
          ./tool/update.sh

      - name: Run go tests
        run: |
          set -e
          go test ./...

      - name: Commit and push if there are changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          if ! git diff --cached --quiet; then
            git commit -m "Auto update from google/brotli ${{ env.tag_name }}"
            git push origin main
          else
            echo "No changes to commit."
            exit 0
          fi

      - name: Create matching version tag
        if: success() && github.ref == 'refs/heads/main'
        run: |
          if git rev-parse "${{ env.tag_name }}" >/dev/null 2>&1; then
            echo "Tag ${{ env.tag_name }} already exists. Skipping."
          else
            git tag "${{ env.tag_name }}"
            git push origin "${{ env.tag_name }}"
            echo "Created and pushed tag: ${{ env.tag_name }}"
          fi
